<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Friends mini-app</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 16px;
            background: #f5f5f5;
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .tab-btn {
            flex: 1;
            padding: 8px 6px;
            border-radius: 999px;
            border: none;
            background: #e5e5ea;
            font-size: 14px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: #007aff;
            color: #fff;
        }
        .tab-page {
            display: none;
        }
        .tab-page.active {
            display: block;
        }
 
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 12px;
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        label {
            font-size: 13px;
            margin-top: 8px;
            display: block;
        }
        input, textarea, select {
            width: 100%;
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #d0d0d0;
            margin-top: 4px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 60px;
        }
        button {
            margin-top: 6px;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background: #007aff;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        button:active { opacity: 0.85; }
        .users-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .user-card {
            background: #fafafa;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .user-meta {
            font-size: 13px;
            color: #666;
            margin-top: 2px;
        }
        #chat_messages {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            height: 220px;
            overflow-y: auto;
        }
        .msg {
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 80%;
        }
        .msg-me {
            background: #007aff;
            color: #fff;
            margin-left: auto;
            text-align: right;
        }
        .msg-other {
            background: #e5e5ea;
            color: #000;
            margin-right: auto;
            text-align: left;
        }
    </style>
</head>
<body>
 
<div class="tabs">
    <button class="tab-btn active" data-tab="profile" onclick="switchTab('profile')">Профиль</button>
    <button class="tab-btn" data-tab="people" onclick="switchTab('people')">Люди</button>
    <button class="tab-btn" data-tab="invites" onclick="switchTab('invites')">Приглашения</button>
    <button class="tab-btn" data-tab="chat" onclick="switchTab('chat')">Чат</button>
</div>
 
<!-- Профиль -->
<div id="tab-profile" class="tab-page active">
    <div class="card">
        <h1>Профиль</h1>
        <form id="profile-form">
            <label>Telegram ID</label>
            <input id="tg_id" name="tg_id" type="number" required>
 
            <label>Имя</label>
            <input id="first_name" name="first_name" type="text" required>
 
            <label>Фамилия</label>
            <input id="last_name" name="last_name" type="text">
 
            <label>Возраст</label>
            <input id="age" name="age" type="number" min="18" max="99">
 
            <label>О себе</label>
            <textarea id="about" name="about"></textarea>
 
            <label>Напитки</label>
            <input id="drinks" name="drinks" type="text">
 
            <label>Темы общения</label>
            <input id="topics" name="topics" type="text">
 
            <label>Город</label>
            <select id="city_select" onchange="onCityChange()">
                <option value="">Выберите город</option>
                <option value="Москва">Москва</option>
                <option value="Санкт-Петербург">Санкт-Петербург</option>
                <option value="Казань">Казань</option>
                <option value="Екатеринбург">Екатеринбург</option>
                <option value="Новосибирск">Новосибирск</option>
                <option value="_other">Другой город</option>
            </select>
 
            <label>Локация (текстом)</label>
            <input id="location" name="location" type="text" placeholder="Если выбрали 'Другой город' — введите здесь">
 
            <label>Геопозиция</label>
            <div id="geo_display">Не определена</div>
            <button type="button" onclick="requestLocation()">Определить геопозицию</button>
            <input id="lat" name="lat" type="hidden">
            <input id="lon" name="lon" type="hidden">
 
            <label>Баланс</label>
            <div id="balance_display">0 ₽</div>
            <button type="button" onclick="addTestBalance()">+100 ₽ (тест)</button>
 
            <label>Подписка</label>
            <div id="sub_status">нет</div>
            <button type="button" onclick="activateTestSubscription()">Включить подписку (тест)</button>
 
            <br><br>
            <button type="submit">Сохранить профиль</button>
            <div id="form-status"></div>
        </form>
    </div>
</div>
 
<!-- Люди рядом -->
<div id="tab-people" class="tab-page">
    <div class="card">
        <h1>Люди рядом</h1>
        <div id="users" class="users-list"></div>
    </div>
</div>
 
<!-- Приглашения -->
<div id="tab-invites" class="tab-page">
    <div class="card">
        <h1>Ваши приглашения</h1>
        <div id="invites" class="users-list"></div>
    </div>
</div>
 
<!-- Чат + диалоги -->
<div id="tab-chat" class="tab-page">
    <div class="card">
        <h1>Диалоги</h1>
        <div id="dialogs" class="users-list"></div>
    </div>
 
    <div class="card">
        <h1>Чат</h1>
        <label>Собеседник (tg_id):</label>
        <input type="number" id="chat_with" placeholder="tg_id собеседника">
 
        <div id="chat_messages"></div>
 
        <div style="margin-top: 8px;">
            <input id="chat_input" placeholder="Сообщение" style="width: 70%;">
            <button type="button" onclick="sendChatMessage()">Отправить</button>
        </div>
    </div>
</div>
 
<script>
let myIsSubscribed = false;
let inviteStatus = {
    sent: {},
    received: {},
    match: {}
};
let lastChatJson = "";
 
// переключение вкладок
function switchTab(tab) {
    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
    });
    document.querySelectorAll(".tab-page").forEach(page => {
        page.classList.toggle("active", page.id === "tab-" + tab);
    });
}
 
// helpers
function getCurrentTgId() {
    const v = document.getElementById("tg_id").value;
    return v ? Number(v) : null;
}
 
function updateBalanceDisplay(value) {
    document.getElementById("balance_display").textContent = value.toFixed(2) + " ₽";
}
 
function updateSubscriptionDisplay(isActive) {
    myIsSubscribed = !!isActive;
    document.getElementById("sub_status").textContent = isActive ? "активна" : "нет";
}
 
function distanceKm(lat1, lon1, lat2, lon2) {
    function toRad(x) { return x * Math.PI / 180; }
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}
 
// город из списка
function onCityChange() {
    const sel = document.getElementById("city_select");
    const locInput = document.getElementById("location");
 
    if (sel.value && sel.value !== "_other") {
        locInput.value = sel.value;
        locInput.readOnly = true;
    } else {
        locInput.readOnly = false;
        if (sel.value !== "_other") {
            locInput.value = "";
        }
    }
}
 
// гео
function requestLocation() {
    const geoDisplay = document.getElementById("geo_display");
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const { latitude, longitude } = pos.coords;
                document.getElementById("lat").value = latitude;
                document.getElementById("lon").value = longitude;
                geoDisplay.textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
            },
            (err) => {
                console.log("Geolocation error", err);
                alert("Не удалось получить геопозицию. Разрешите доступ к геоданным.");
            }
        );
    } else {
        alert("Геолокация недоступна в этом окружении.");
    }
}
 
// баланс / подписка (тест)
async function addTestBalance() {
    const tg = getCurrentTgId();
    if (!tg) return alert("Сначала заполните профиль и сохраните его.");
 
    const res = await fetch("/api/balance/add", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ tg_id: tg, amount: 100 })
    });
 
    if (!res.ok) {
        alert("Ошибка пополнения баланса");
        return;
    }
 
    const data = await res.json();
    updateBalanceDisplay(data.balance);
    updateSubscriptionDisplay(data.is_subscribed);
}
 
async function activateTestSubscription() {
    const tg = getCurrentTgId();
    if (!tg) return alert("Сначала заполните профиль и сохраните его.");
 
    const res = await fetch("/api/subscribe", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ tg_id: tg, active: true })
    });
 
    if (!res.ok) {
        alert("Ошибка изменения подписки");
        return;
    }
 
    const data = await res.json();
    updateBalanceDisplay(data.balance);
    updateSubscriptionDisplay(data.is_subscribed);
}
 
// профиль
async function saveProfile(event) {
    event.preventDefault();
 
    const tgIdInput = document.getElementById("tg_id");
    const tg = tgIdInput.value ? Number(tgIdInput.value) : null;
    if (!tg) {
        alert("Укажите Telegram ID");
        return;
    }
 
    const payload = {
        tg_id: tg,
        first_name: document.getElementById("first_name").value,
        last_name: document.getElementById("last_name").value || null,
        middle_name: null,
        age: document.getElementById("age").value ? Number(document.getElementById("age").value) : null,
        about: document.getElementById("about").value || null,
        drinks: document.getElementById("drinks").value || null,
        topics: document.getElementById("topics").value || null,
        location: document.getElementById("location").value || null,
        lat: document.getElementById("lat").value ? Number(document.getElementById("lat").value) : null,
        lon: document.getElementById("lon").value ? Number(document.getElementById("lon").value) : null
    };
 
    const res = await fetch("/api/profile", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });
 
    if (!res.ok) {
        document.getElementById("form-status").textContent = "Ошибка сохранения профиля";
        return;
    }
 
    const data = await res.json();
    updateBalanceDisplay(data.balance);
    updateSubscriptionDisplay(data.is_subscribed);
    document.getElementById("form-status").textContent = "Профиль сохранён";
 
    await loadInvites();
    await loadDialogs();
    await loadChat();
}
 
// открыть чат с пользователем
function openChatWith(otherId) {
    document.getElementById("chat_with").value = otherId;
    loadChat();
}
 
// люди рядом
async function loadUsers() {
    const res = await fetch("/api/users");
    const users = await res.json();
    const my = getCurrentTgId();
 
    const myLat = parseFloat(document.getElementById("lat").value || "NaN");
    const myLon = parseFloat(document.getElementById("lon").value || "NaN");
 
    const root = document.getElementById("users");
    root.innerHTML = "";
 
    let enriched = users.map(u => {
        let dist = null;
        if (!isNaN(myLat) && !isNaN(myLon) && u.lat !== null && u.lon !== null) {
            dist = distanceKm(myLat, myLon, u.lat, u.lon);
        }
        return { ...u, distance_km: dist };
    });
 
    enriched.sort((a, b) => {
        if (a.distance_km == null && b.distance_km == null) return 0;
        if (a.distance_km == null) return 1;
        if (b.distance_km == null) return -1;
        return a.distance_km - b.distance_km;
    });
 
    enriched.forEach(u => {
        const div = document.createElement("div");
        div.className = "user-card";
 
        let title = u.first_name;
        if (u.age) title += ", " + u.age;
 
        const nameDiv = document.createElement("div");
        nameDiv.className = "user-name";
        nameDiv.textContent = title;
 
        const metaDiv = document.createElement("div");
        metaDiv.className = "user-meta";
 
        let locText = u.location || "нет локации";
        if (u.distance_km != null) {
            const km = u.distance_km;
            if (km < 1) {
                locText += ` • ~${Math.round(km * 1000)} м`;
            } else {
                locText += ` • ~${km.toFixed(1)} км`;
            }
        }
        metaDiv.textContent = locText;
 
        div.appendChild(nameDiv);
        div.appendChild(metaDiv);
 
        if (my && u.tg_id !== my) {
            const actions = document.createElement("div");
            actions.style.marginTop = "6px";
            actions.style.display = "flex";
            actions.style.gap = "6px";
 
            const otherId = u.tg_id;
 
            if (inviteStatus.match[otherId]) {
                const chatBtn = document.createElement("button");
                chatBtn.textContent = "Чат";
                chatBtn.onclick = () => openChatWith(otherId);
                actions.appendChild(chatBtn);
            } else if (inviteStatus.sent[otherId]) {
                const info = document.createElement("div");
                info.className = "user-meta";
                info.textContent = "Ожидает ответа";
                actions.appendChild(info);
            } else if (inviteStatus.received[otherId]) {
                const acceptBtn = document.createElement("button");
                acceptBtn.textContent = "Принять";
                acceptBtn.onclick = () => {
                    sendInvite(my, otherId);
                };
                actions.appendChild(acceptBtn);
            } else {
                const inviteBtn = document.createElement("button");
                inviteBtn.textContent = "Пригласить";
                inviteBtn.onclick = () => {
                    sendInvite(my, otherId);
                };
                actions.appendChild(inviteBtn);
            }
 
            if (myIsSubscribed && !inviteStatus.match[otherId]) {
                const chatBtn = document.createElement("button");
                chatBtn.textContent = "Чат";
                chatBtn.onclick = () => openChatWith(otherId);
                actions.appendChild(chatBtn);
            }
 
            div.appendChild(actions);
        }
 
        root.appendChild(div);
    });
}
 
// инвайты
async function sendInvite(from, to) {
    const res = await fetch("/api/invite", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ from_tg_id: from, to_tg_id: to })
    });
 
    if (!res.ok) {
        let msg = "Ошибка приглашения";
        try {
            const err = await res.json();
            if (err.detail) msg = err.detail;
        } catch (_) {}
        alert(msg);
        return;
    }
 
    await loadInvites();
}
 
async function loadInvites() {
    const tg = getCurrentTgId();
    const root = document.getElementById("invites");
 
    if (!tg) {
        root.innerHTML = "Укажите Telegram ID и сохраните профиль, чтобы видеть приглашения.";
        inviteStatus.sent = {};
        inviteStatus.received = {};
        inviteStatus.match = {};
        loadUsers();
        return;
    }
 
    const res = await fetch(`/api/invites?tg_id=${tg}`);
    const inv = await res.json();
 
    inviteStatus.sent = {};
    inviteStatus.received = {};
    inviteStatus.match = {};
 
    inv.forEach(r => {
        if (r.from_tg_id === tg) {
            inviteStatus.sent[r.to_tg_id] = true;
        }
        if (r.to_tg_id === tg) {
            inviteStatus.received[r.from_tg_id] = true;
        }
    });
 
    Object.keys(inviteStatus.sent).forEach(idStr => {
        const id = Number(idStr);
        if (inviteStatus.received[id]) {
            inviteStatus.match[id] = true;
        }
    });
 
    root.innerHTML = "";
 
    const ids = new Set([
        ...Object.keys(inviteStatus.sent),
        ...Object.keys(inviteStatus.received)
    ]);
 
    if (!ids.size) {
        root.textContent = "Пока нет приглашений.";
    } else {
        ids.forEach(idStr => {
            const otherId = Number(idStr);
            const div = document.createElement("div");
            div.className = "user-card";
 
            let text = "";
            if (inviteStatus.match[otherId]) {
                text = `Матч с ${otherId}`;
            } else if (inviteStatus.sent[otherId] && !inviteStatus.received[otherId]) {
                text = `Вы пригласили ${otherId}`;
            } else if (inviteStatus.received[otherId] && !inviteStatus.sent[otherId]) {
                text = `Вас пригласил ${otherId}`;
            } else {
                text = `Контакт ${otherId}`;
            }
 
            div.textContent = text;
            root.appendChild(div);
        });
    }
 
    loadUsers();
}
 
// диалоги
async function loadDialogs() {
    const me = getCurrentTgId();
    const root = document.getElementById("dialogs");
    root.innerHTML = "";
 
    if (!me) {
        root.textContent = "Сначала заполните профиль и сохраните его.";
        return;
    }
 
    const res = await fetch(`/api/dialogs?tg_id=${me}`);
    if (!res.ok) {
        root.textContent = "Не удалось загрузить диалоги.";
        return;
    }
 
    const dialogs = await res.json();
    if (!dialogs.length) {
        root.textContent = "Пока нет диалогов.";
        return;
    }
 
    dialogs.forEach(d => {
        const div = document.createElement("div");
        div.className = "user-card";
        div.style.cursor = "pointer";
 
        const title = document.createElement("div");
        title.className = "user-name";
        title.textContent = d.other_name || d.other_tg_id;
 
        const meta = document.createElement("div");
        meta.className = "user-meta";
        meta.textContent = d.last_text || "(пока без текста)";
 
        div.appendChild(title);
        div.appendChild(meta);
 
        div.onclick = () => openChatWith(d.other_tg_id);
 
        root.appendChild(div);
    });
}
 
// чат
async function sendChatMessage() {
    const from = getCurrentTgId();
    const to = Number(document.getElementById("chat_with").value);
    const text = document.getElementById("chat_input").value;
 
    if (!from || !to || !text.trim()) return;
 
    const res = await fetch("/api/messages", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ from_tg_id: from, to_tg_id: to, text })
    });
 
    if (!res.ok) {
        let msg = "Ошибка отправки сообщения";
        try {
            const err = await res.json();
            if (err.detail) msg = err.detail;
        } catch (_) {}
        alert(msg);
        return;
    }
 
    document.getElementById("chat_input").value = "";
    await loadChat();
    await loadDialogs();
}
 
async function loadChat() {
    const me = getCurrentTgId();
    const other = Number(document.getElementById("chat_with").value);
    if (!me || !other) return;
 
    const res = await fetch(`/api/chat?user1=${me}&user2=${other}`);
    if (!res.ok) return;
 
    const msgs = await res.json();
    const jsonNow = JSON.stringify(msgs);
    if (jsonNow === lastChatJson) {
        return;
    }
    lastChatJson = jsonNow;
 
    const root = document.getElementById("chat_messages");
    root.innerHTML = "";
 
    msgs.forEach(m => {
        const div = document.createElement("div");
        div.className = "msg " + (m.from_tg_id === me ? "msg-me" : "msg-other");
        div.textContent = (m.from_tg_id === me ? "Вы: " : "Он/она: ") + m.text;
        root.appendChild(div);
    });
 
    root.scrollTop = root.scrollHeight;
}
 
// Telegram WebApp init
(function initTelegram() {
    try {
        const tg = window.Telegram && window.Telegram.WebApp;
        if (!tg) return;
        tg.expand();
        const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
        if (user && user.id) {
            const tgInput = document.getElementById("tg_id");
            tgInput.value = user.id;
            tgInput.readOnly = true;
        }
    } catch (e) {
        console.log("Telegram WebApp init error", e);
    }
})();
 
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("profile-form").addEventListener("submit", saveProfile);
    switchTab("people"); // по умолчанию открываем вкладку "Люди"
    loadInvites();
    loadDialogs();
    setInterval(loadChat, 2000); // автообновление только чата
});
</script>
</body>
</html>