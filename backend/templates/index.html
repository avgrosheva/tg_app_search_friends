<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Friends mini-app</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-main: #0F0F0F;
            --bg-card: #1B1B1B;
            --bg-input: #232323;
            --border-subtle: #2A2A2A;
            --accent: #D9333A;
            --accent-soft: #C27C3C;
            --text-main: #FFFFFF;
            --text-muted: #A1A1A1;
            --success: #3CC27C;
        }
 
        * {
            box-sizing: border-box;
        }
 
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
            margin: 0;
            background: var(--bg-main);
            color: var(--text-main);
        }
 
        .app {
            max-width: 420px;
            margin: 0 auto;
            padding: 16px 16px 72px; /* отступ под нижнее меню */
        }
 
        .tab-page {
            display: none;
        }
 
        .tab-page.active {
            display: block;
        }
 
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border-subtle);
            margin-bottom: 12px;
        }
 
        h1 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
 
        label {
            font-size: 13px;
            margin-top: 8px;
            display: block;
            color: var(--text-muted);
        }
 
        input, textarea, select {
            width: 100%;
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            margin-top: 4px;
            background: var(--bg-input);
            color: var(--text-main);
        }
 
        input::placeholder,
        textarea::placeholder {
            color: #707070;
        }
 
        textarea {
            min-height: 60px;
            resize: vertical;
        }
 
        button {
            margin-top: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            background: var(--accent);
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
 
        button:active {
            opacity: 0.9;
        }
 
        .btn-secondary {
            background: #1B1B1B;
            color: var(--text-main);
            border: 1px solid var(--border-subtle);
            font-weight: 500;
        }
 
        .btn-inline {
            margin-top: 0;
        }
 
        .users-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
 
        .user-card {
            background: #151515;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid var(--border-subtle);
        }
 
        .user-card:hover {
            border-color: #3A3A3A;
        }
 
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 4px;
        }
 
        .user-name {
            font-weight: 600;
            font-size: 16px;
        }
 
        .user-distance {
            font-size: 13px;
            color: var(--text-muted);
        }
 
        .user-meta {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 2px;
        }
 
        .user-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }
 
        .tag-pill {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 999px;
            background: #242424;
            color: var(--text-muted);
        }
 
        .user-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
 
        .user-actions > button {
            flex: 1;
        }
 
        #chat_messages {
            background: #151515;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 8px;
            height: 220px;
            overflow-y: auto;
        }
 
        .msg {
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 8px;
            font-size: 14px;
            max-width: 80%;
        }
 
        .msg-me {
            background: var(--accent);
            color: #fff;
            margin-left: auto;
            text-align: right;
        }
 
        .msg-other {
            background: #232323;
            color: #fff;
            margin-right: auto;
            text-align: left;
        }
 
        .hint-text {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }
 
        .section-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
 
        .badge-sub {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(201, 143, 76, 0.15);
            color: var(--accent-soft);
            font-size: 11px;
            font-weight: 500;
            margin-left: 6px;
        }
 
        .status-success {
            color: var(--success);
            font-size: 13px;
        }
 
        .status-error {
            color: var(--accent);
            font-size: 13px;
        }
 
        /* Нижняя навигация */
        .bottom-nav {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            width: 100%;
            max-width: 420px;
            background: #101010;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-around;
            padding: 6px 0;
            z-index: 100;
        }
 
        .bottom-nav-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            padding: 6px 0 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            cursor: pointer;
        }
 
        .bottom-nav-btn span {
            font-size: 11px;
        }
 
        .bottom-nav-btn.active {
            color: #fff;
        }
 
        .bottom-nav-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: transparent;
        }
 
        .bottom-nav-btn.active .bottom-nav-dot {
            background: var(--accent);
        }
    </style>
</head>
<body>
 
<div class="app">
    <!-- Профиль -->
    <div id="tab-profile" class="tab-page">
        <div class="card">
            <div class="section-title-row">
                <h1>Профиль</h1>
                <span id="sub_badge" class="badge-sub" style="display:none;">Подписка активна</span>
            </div>
            <form id="profile-form">
                <label>Telegram ID</label>
                <input id="tg_id" name="tg_id" type="number" required>
 
                <label>Имя</label>
                <input id="first_name" name="first_name" type="text" required>
 
                <label>Фамилия</label>
                <input id="last_name" name="last_name" type="text">
 
                <label>Возраст</label>
                <input id="age" name="age" type="number" min="18" max="99">
 
                <label>О себе</label>
                <textarea id="about" name="about" placeholder="Коротко о себе..."></textarea>
 
                <label>Напитки</label>
                <input id="drinks" name="drinks" type="text" placeholder="Например: виски, вино, кофе">
 
                <label>Темы общения</label>
                <input id="topics" name="topics" type="text" placeholder="Например: музыка, IT, путешествия">
 
                <label>Город</label>
                <select id="city_select" onchange="onCityChange()">
                    <option value="">Выберите город</option>
                    <option value="Москва">Москва</option>
                    <option value="Санкт-Петербург">Санкт-Петербург</option>
                    <option value="Казань">Казань</option>
                    <option value="Екатеринбург">Екатеринбург</option>
                    <option value="Новосибирск">Новосибирск</option>
                    <option value="_other">Другой город</option>
                </select>
 
                <label>Локация (текстом)</label>
                <input id="location" name="location" type="text" placeholder="Если выбрали 'Другой город' — введите здесь">
 
                <label>Геопозиция</label>
                <div id="geo_display" class="hint-text">Не определена</div>
                <button type="button" class="btn-secondary" onclick="requestLocation()">Определить геопозицию</button>
                <input id="lat" name="lat" type="hidden">
                <input id="lon" name="lon" type="hidden">
 
                <label>Баланс</label>
                <div id="balance_display">0 ₽</div>
                <button type="button" class="btn-secondary" onclick="addTestBalance()">+100 ₽ (тест)</button>
 
                <label>Подписка</label>
                <div id="sub_status" class="hint-text">нет</div>
                <button type="button" class="btn-secondary" onclick="activateTestSubscription()">Включить подписку (тест)</button>
 
                <br><br>
                <button type="submit">Сохранить профиль</button>
                <div id="form-status" class="hint-text"></div>
            </form>
        </div>
    </div>
 
    <!-- Люди рядом -->
    <div id="tab-people" class="tab-page">
        <div class="card">
            <div class="section-title-row">
                <h1>Люди рядом</h1>
            </div>
            <div id="users" class="users-list"></div>
        </div>
    </div>
 
    <!-- Матчи / Приглашения -->
    <div id="tab-invites" class="tab-page">
        <div class="card">
            <h1>Матчи и приглашения</h1>
            <div id="invites" class="users-list"></div>
        </div>
    </div>
 
    <!-- Чат + диалоги -->
    <div id="tab-chat" class="tab-page">
        <div class="card">
            <h1>Диалоги</h1>
            <div id="dialogs" class="users-list"></div>
        </div>
 
        <div class="card">
            <h1>Чат</h1>
            <label>Собеседник (tg_id):</label>
            <input type="number" id="chat_with" placeholder="tg_id собеседника">
 
            <div id="chat_messages"></div>
 
            <div style="margin-top: 8px; display:flex; gap:8px;">
                <input id="chat_input" placeholder="Сообщение" style="flex:1;">
                <button type="button" onclick="sendChatMessage()">Отправить</button>
            </div>
        </div>
    </div>
</div>
 
<!-- Нижнее меню -->
<div class="bottom-nav">
    <button class="bottom-nav-btn" data-tab="profile" onclick="switchTab('profile')">
        <span>Профиль</span>
        <div class="bottom-nav-dot"></div>
    </button>
    <button class="bottom-nav-btn" data-tab="people" onclick="switchTab('people')">
        <span>Люди</span>
        <div class="bottom-nav-dot"></div>
    </button>
    <button class="bottom-nav-btn" data-tab="invites" onclick="switchTab('invites')">
        <span>Матчи</span>
        <div class="bottom-nav-dot"></div>
    </button>
    <button class="bottom-nav-btn" data-tab="chat" onclick="switchTab('chat')">
        <span>Чат</span>
        <div class="bottom-nav-dot"></div>
    </button>
</div>
 
<script>
let myIsSubscribed = false;
let inviteStatus = {
    sent: {},
    received: {},
    match: {}
};
let lastChatJson = "";
 
// переключение вкладок
function switchTab(tab) {
    document.querySelectorAll(".tab-page").forEach(page => {
        page.classList.toggle("active", page.id === "tab-" + tab);
    });
    document.querySelectorAll(".bottom-nav-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tab);
    });
}
 
// helpers
function getCurrentTgId() {
    const v = document.getElementById("tg_id").value;
    return v ? Number(v) : null;
}
 
function updateBalanceDisplay(value) {
    document.getElementById("balance_display").textContent = value.toFixed(2) + " ₽";
}
 
function updateSubscriptionDisplay(isActive) {
    myIsSubscribed = !!isActive;
    document.getElementById("sub_status").textContent = isActive ? "активна" : "нет";
    const badge = document.getElementById("sub_badge");
    badge.style.display = isActive ? "inline-flex" : "none";
}
 
function distanceKm(lat1, lon1, lat2, lon2) {
    function toRad(x) { return x * Math.PI / 180; }
    const R = 6371;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}
 
// город из списка
function onCityChange() {
    const sel = document.getElementById("city_select");
    const locInput = document.getElementById("location");
 
    if (sel.value && sel.value !== "_other") {
        locInput.value = sel.value;
        locInput.readOnly = true;
    } else {
        locInput.readOnly = false;
        if (sel.value !== "_other") {
            locInput.value = "";
        }
    }
}
 
// гео
function requestLocation() {
    const geoDisplay = document.getElementById("geo_display");
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const { latitude, longitude } = pos.coords;
                document.getElementById("lat").value = latitude;
                document.getElementById("lon").value = longitude;
                geoDisplay.textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
            },
            (err) => {
                console.log("Geolocation error", err);
                alert("Не удалось получить геопозицию. Разрешите доступ к геоданным.");
            }
        );
    } else {
        alert("Геолокация недоступна в этом окружении.");
    }
}
 
// баланс / подписка (тест)
async function addTestBalance() {
    const tg = getCurrentTgId();
    if (!tg) return alert("Сначала заполните профиль и сохраните его.");
 
    const res = await fetch("/api/balance/add", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ tg_id: tg, amount: 100 })
    });
 
    if (!res.ok) {
        alert("Ошибка пополнения баланса");
        return;
    }
 
    const data = await res.json();
    updateBalanceDisplay(data.balance);
    updateSubscriptionDisplay(data.is_subscribed);
}
 
async function activateTestSubscription() {
    const tg = getCurrentTgId();
    if (!tg) return alert("Сначала заполните профиль и сохраните его.");
 
    const res = await fetch("/api/subscribe", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ tg_id: tg, active: true })
    });
 
    if (!res.ok) {
        alert("Ошибка изменения подписки");
        return;
    }
 
    const data = await res.json();
    updateBalanceDisplay(data.balance);
    updateSubscriptionDisplay(data.is_subscribed);
}
 
// профиль
async function saveProfile(event) {
    event.preventDefault();
 
    const tgIdInput = document.getElementById("tg_id");
    const tg = tgIdInput.value ? Number(tgIdInput.value) : null;
    if (!tg) {
        alert("Укажите Telegram ID");
        return;
    }
 
    const payload = {
        tg_id: tg,
        first_name: document.getElementById("first_name").value,
        last_name: document.getElementById("last_name").value || null,
        middle_name: null,
        age: document.getElementById("age").value ? Number(document.getElementById("age").value) : null,
        about: document.getElementById("about").value || null,
        drinks: document.getElementById("drinks").value || null,
        topics: document.getElementById("topics").value || null,
        location: document.getElementById("location").value || null,
        lat: document.getElementById("lat").value ? Number(document.getElementById("lat").value) : null,
        lon: document.getElementById("lon").value ? Number(document.getElementById("lon").value) : null
    };
 
    const res = await fetch("/api/profile", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });
 
    if (!res.ok) {
        document.getElementById("form-status").textContent = "Ошибка сохранения профиля";
        document.getElementById("form-status").className = "hint-text status-error";
        return;
    }
 
    const data = await res.json();
    updateBalanceDisplay(data.balance);
    updateSubscriptionDisplay(data.is_subscribed);
    const fs = document.getElementById("form-status");
    fs.textContent = "Профиль сохранён";
    fs.className = "hint-text status-success";
 
    await loadInvites();
    await loadDialogs();
    await loadChat();
}
 
// открыть чат с пользователем
function openChatWith(otherId) {
    document.getElementById("chat_with").value = otherId;
    switchTab("chat");
    loadChat();
}
 
// люди рядом
async function loadUsers() {
    const res = await fetch("/api/users");
    const users = await res.json();
    const my = getCurrentTgId();
 
    const myLat = parseFloat(document.getElementById("lat").value || "NaN");
    const myLon = parseFloat(document.getElementById("lon").value || "NaN");
 
    const root = document.getElementById("users");
    root.innerHTML = "";
 
    if (!users.length) {
        root.innerHTML = '<div class="hint-text">Пока никого нет рядом.</div>';
        return;
    }
 
    let enriched = users.map(u => {
        let dist = null;
        if (!isNaN(myLat) && !isNaN(myLon) && u.lat !== null && u.lon !== null) {
            dist = distanceKm(myLat, myLon, u.lat, u.lon);
        }
        return { ...u, distance_km: dist };
    });
 
    enriched.sort((a, b) => {
        if (a.distance_km == null && b.distance_km == null) return 0;
        if (a.distance_km == null) return 1;
        if (b.distance_km == null) return -1;
        return a.distance_km - b.distance_km;
    });
 
    enriched.forEach(u => {
        const card = document.createElement("div");
        card.className = "user-card";
 
        const header = document.createElement("div");
        header.className = "user-header";
 
        let title = u.first_name || "Без имени";
        if (u.age) title += ", " + u.age;
 
        const nameDiv = document.createElement("div");
        nameDiv.className = "user-name";
        nameDiv.textContent = title;
 
        const distDiv = document.createElement("div");
        distDiv.className = "user-distance";
        if (u.distance_km != null) {
            const km = u.distance_km;
            distDiv.textContent = km < 1
                ? `~${Math.round(km * 1000)} м`
                : `~${km.toFixed(1)} км`;
        } else {
            distDiv.textContent = "";
        }
 
        header.appendChild(nameDiv);
        header.appendChild(distDiv);
        card.appendChild(header);
 
        const metaDiv = document.createElement("div");
        metaDiv.className = "user-meta";
        metaDiv.textContent = u.location || "Локация не указана";
        card.appendChild(metaDiv);
 
        const tagsWrapper = document.createElement("div");
        tagsWrapper.className = "user-tags";
        const tags = [];
        if (u.drinks) tags.push(u.drinks);
        if (u.topics) tags.push(u.topics);
 
        tags.forEach(t => {
            const pill = document.createElement("div");
            pill.className = "tag-pill";
            pill.textContent = t;
            tagsWrapper.appendChild(pill);
        });
 
        if (tags.length) {
            card.appendChild(tagsWrapper);
        }
 
        if (my && u.tg_id !== my) {
            const actions = document.createElement("div");
            actions.className = "user-actions";
 
            const otherId = u.tg_id;
 
            if (inviteStatus.match[otherId]) {
                const chatBtn = document.createElement("button");
                chatBtn.textContent = "Чат";
                chatBtn.onclick = () => openChatWith(otherId);
                actions.appendChild(chatBtn);
            } else if (inviteStatus.sent[otherId]) {
                const info = document.createElement("button");
                info.className = "btn-secondary btn-inline";
                info.textContent = "Ожидает ответа";
                info.disabled = true;
                actions.appendChild(info);
            } else if (inviteStatus.received[otherId]) {
                const acceptBtn = document.createElement("button");
                acceptBtn.textContent = "Принять";
                acceptBtn.onclick = () => {
                    sendInvite(my, otherId);
                };
                actions.appendChild(acceptBtn);
            } else {
                const inviteBtn = document.createElement("button");
                inviteBtn.textContent = "Пригласить";
                inviteBtn.onclick = () => {
                    sendInvite(my, otherId);
                };
                actions.appendChild(inviteBtn);
            }
 
            if (myIsSubscribed && !inviteStatus.match[otherId]) {
                const chatBtn = document.createElement("button");
                chatBtn.className = "btn-secondary";
                chatBtn.textContent = "Чат";
                chatBtn.onclick = () => openChatWith(otherId);
                actions.appendChild(chatBtn);
            }
 
            card.appendChild(actions);
        }
 
        root.appendChild(card);
    });
}
 
// инвайты / матчи
async function sendInvite(from, to) {
    const res = await fetch("/api/invite", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ from_tg_id: from, to_tg_id: to })
    });
 
    if (!res.ok) {
        let msg = "Ошибка приглашения";
        try {
            const err = await res.json();
            if (err.detail) msg = err.detail;
        } catch (_) {}
        alert(msg);
        return;
    }
 
    try {
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.impactOccurred("light");
        }
    } catch (e) {}
 
    await loadInvites();
}
 
async function loadInvites() {
    const tg = getCurrentTgId();
    const root = document.getElementById("invites");
 
    if (!tg) {
        root.innerHTML = '<div class="hint-text">Укажите Telegram ID и сохраните профиль, чтобы видеть приглашения.</div>';
        inviteStatus.sent = {};
        inviteStatus.received = {};
        inviteStatus.match = {};
        loadUsers();
        return;
    }
 
    const res = await fetch(`/api/invites?tg_id=${tg}`);
    const inv = await res.json();
 
    inviteStatus.sent = {};
    inviteStatus.received = {};
    inviteStatus.match = {};
 
    inv.forEach(r => {
        if (r.from_tg_id === tg) {
            inviteStatus.sent[r.to_tg_id] = true;
        }
        if (r.to_tg_id === tg) {
            inviteStatus.received[r.from_tg_id] = true;
        }
    });
 
    Object.keys(inviteStatus.sent).forEach(idStr => {
        const id = Number(idStr);
        if (inviteStatus.received[id]) {
            inviteStatus.match[id] = true;
        }
    });
 
    root.innerHTML = "";
 
    const ids = new Set([
        ...Object.keys(inviteStatus.sent),
        ...Object.keys(inviteStatus.received)
    ]);
 
    if (!ids.size) {
        root.innerHTML = '<div class="hint-text">Пока нет приглашений.</div>';
    } else {
        ids.forEach(idStr => {
            const otherId = Number(idStr);
            const div = document.createElement("div");
            div.className = "user-card";
 
            let text = "";
            if (inviteStatus.match[otherId]) {
                text = `Матч с ${otherId}`;
            } else if (inviteStatus.sent[otherId] && !inviteStatus.received[otherId]) {
                text = `Вы пригласили ${otherId}`;
            } else if (inviteStatus.received[otherId] && !inviteStatus.sent[otherId]) {
                text = `Вас пригласил ${otherId}`;
            } else {
                text = `Контакт ${otherId}`;
            }
 
            div.textContent = text;
            root.appendChild(div);
        });
    }
 
    loadUsers();
}
 
// диалоги
async function loadDialogs() {
    const me = getCurrentTgId();
    const root = document.getElementById("dialogs");
    root.innerHTML = "";
 
    if (!me) {
        root.innerHTML = '<div class="hint-text">Сначала заполните профиль и сохраните его.</div>';
        return;
    }
 
    const res = await fetch(`/api/dialogs?tg_id=${me}`);
    if (!res.ok) {
        root.innerHTML = '<div class="hint-text">Не удалось загрузить диалоги.</div>';
        return;
    }
 
    const dialogs = await res.json();
    if (!dialogs.length) {
        root.innerHTML = '<div class="hint-text">Пока нет диалогов.</div>';
        return;
    }
 
    dialogs.forEach(d => {
        const div = document.createElement("div");
        div.className = "user-card";
        div.style.cursor = "pointer";
 
        const header = document.createElement("div");
        header.className = "user-header";
 
        const title = document.createElement("div");
        title.className = "user-name";
        title.textContent = d.other_name || d.other_tg_id;
 
        const lastTs = document.createElement("div");
        lastTs.className = "user-distance";
        lastTs.textContent = ""; // можно позже красиво форматировать время
 
        header.appendChild(title);
        header.appendChild(lastTs);
        div.appendChild(header);
 
        const meta = document.createElement("div");
        meta.className = "user-meta";
        meta.textContent = d.last_text || "(пока без текста)";
        div.appendChild(meta);
 
        div.onclick = () => openChatWith(d.other_tg_id);
 
        root.appendChild(div);
    });
}
 
// чат
async function sendChatMessage() {
    const from = getCurrentTgId();
    const to = Number(document.getElementById("chat_with").value);
    const text = document.getElementById("chat_input").value;
 
    if (!from || !to || !text.trim()) return;
 
    const res = await fetch("/api/messages", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ from_tg_id: from, to_tg_id: to, text })
    });
 
    if (!res.ok) {
        let msg = "Ошибка отправки сообщения";
        try {
            const err = await res.json();
            if (err.detail) msg = err.detail;
        } catch (_) {}
        alert(msg);
        return;
    }
 
    try {
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback) {
            Telegram.WebApp.HapticFeedback.impactOccurred("light");
        }
    } catch (e) {}
 
    document.getElementById("chat_input").value = "";
    await loadChat();
    await loadDialogs();
}
 
async function loadChat() {
    const me = getCurrentTgId();
    const other = Number(document.getElementById("chat_with").value);
    if (!me || !other) return;
 
    const res = await fetch(`/api/chat?user1=${me}&user2=${other}`);
    if (!res.ok) return;
 
    const msgs = await res.json();
    const jsonNow = JSON.stringify(msgs);
    if (jsonNow === lastChatJson) {
        return;
    }
    lastChatJson = jsonNow;
 
    const root = document.getElementById("chat_messages");
    root.innerHTML = "";
 
    if (!msgs.length) {
        root.innerHTML = '<div class="hint-text">Пока нет сообщений.</div>';
        return;
    }
 
    msgs.forEach(m => {
        const div = document.createElement("div");
        div.className = "msg " + (m.from_tg_id === me ? "msg-me" : "msg-other");
        div.textContent = (m.from_tg_id === me ? "Вы: " : "Он/она: ") + m.text;
        root.appendChild(div);
    });
 
    root.scrollTop = root.scrollHeight;
}
 
// Telegram WebApp init
(function initTelegram() {
    try {
        const tg = window.Telegram && window.Telegram.WebApp;
        if (!tg) return;
        tg.expand();
        const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
        if (user && user.id) {
            const tgInput = document.getElementById("tg_id");
            tgInput.value = user.id;
            tgInput.readOnly = true;
        }
    } catch (e) {
        console.log("Telegram WebApp init error", e);
    }
})();
 
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("profile-form").addEventListener("submit", saveProfile);
    switchTab("people"); // по умолчанию открываем "Люди"
    loadInvites();
    loadDialogs();
    setInterval(loadChat, 2000); // автообновление только чата
    loadUsers();
});
</script>
</body>
</html>